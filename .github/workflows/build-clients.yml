name: Build clients on newest UMD

on:
  workflow_dispatch:
    inputs:
      timeout:
        required: true
        description: 'The timeout for the job in minutes'
        type: number
        default: 90
  pull_request:
  push:
    branches: ["main"]

jobs:
  build-tt-metal:
    # Due to parsing bug, fromJSON is used to convert string to number.
    # In pull_request or push events, the input context is not available, stating the default again here.
    timeout-minutes: ${{ fromJSON(inputs.timeout || '90') }}

    name: Build tt-metal with newest UMD
    runs-on: tt-ubuntu-2204-large-stable
    container:
      image: ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-dev-amd64:latest
      env:
        # TODO: Revisit the addition of these env vars https://github.com/tenstorrent/tt-metal/issues/20161
        TRACY_NO_INVARIANT_CHECK: 1
        TRACY_NO_ISA_EXTENSIONS: 1

    steps:
      - name: Checkout tt-metal repo
        uses: actions/checkout@v4
        with:
          # Clone under tt-metal directory
          path: tt-metal
          repository: tenstorrent/tt-metal
          submodules: recursive
          fetch-depth: 500  # Need enough history for `git describe`
          fetch-tags: true  # Need tags for `git describe`

      - name: Checkout UMD
        uses: actions/checkout@v4
        with:
          # Clone directly into tt-metal directory for umd
          path: tt-metal/tt_metal/third_party/umd
          submodules: recursive

      - name: Build tt-metal
        run: |
          cd tt-metal
          export TT_METAL_HOME=$(pwd)
          export PYTHONPATH=$(pwd)
          ./build_metal.sh --build-all --enable-ccache
          cd ../

  build-tt-exalens:
    timeout-minutes: ${{ fromJSON(inputs.timeout || '90') }}

    name: Build tt-exalens with newest UMD
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/tenstorrent/tt-exalens/tt-exalens-ci-ubuntu-22-04:latest

    steps:
      - name: Checkout tt-exalens repo
        uses: actions/checkout@v4
        with:
          # Clone under tt-exalens directory
          path: tt-exalens
          repository: tenstorrent/tt-exalens
          submodules: recursive

      - name: Checkout UMD
        uses: actions/checkout@v4
        with:
          # Clone directly into tt-exalens directory for umd
          path: tt-exalens/third_party/umd
          submodules: recursive

      - name: Build tt-exalens
        run: |
          cd tt-exalens
          make build
          cd ../

  build-tt-sim:
    # Due to parsing bug, fromJSON is used to convert string to number.
    # In pull_request or push events, the input context is not available, stating the default again here.
    timeout-minutes: ${{ fromJSON(inputs.timeout || '90') }}

    name: Build and run ttsim with newest UMD
    runs-on: tt-ubuntu-2204-large-stable
    container:
      image: ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-dev-amd64:latest
      env:
        # TODO: Revisit the addition of these env vars https://github.com/tenstorrent/tt-metal/issues/20161
        TRACY_NO_INVARIANT_CHECK: 1
        TRACY_NO_ISA_EXTENSIONS: 1

    steps:
      - name: Checkout tt-metal repo
        uses: actions/checkout@v4
        with:
          # Clone under tt-metal directory
          path: tt-metal
          repository: tenstorrent/tt-metal
          submodules: recursive
          fetch-depth: 500  # Need enough history for `git describe`
          fetch-tags: true  # Need tags for `git describe`

      - name: Checkout UMD
        uses: actions/checkout@v4
        with:
          # Clone directly into tt-metal directory for umd
          path: tt-metal/tt_metal/third_party/umd
          submodules: recursive

      - name: Get ttsim version
        id: get-ttsim-version
        run: |
          # Extract the default ttsim-version value from tt-metal's ttsim.yaml
          if [ -f "tt-metal/.github/workflows/ttsim.yaml" ]; then
            TTSIM_VERSION=$(grep -A 5 "ttsim-version:" tt-metal/.github/workflows/ttsim.yaml \
                      | grep "default:" \
                      | sed 's/.*default: *"\?\([^"]*\)"\?.*/\1/' \
                      | tr -d ' ')
            if [ -z "$TTSIM_VERSION" ]; then
              echo "Warning: Could not extract ttsim version from input default, using v1.0.0"
              TTSIM_VERSION="v1.0.0"
            fi
          else
            echo "Warning: ttsim.yaml not found, using v1.0.0"
            TTSIM_VERSION="v1.0.0"
          fi
          echo "Extracted ttsim version: $TTSIM_VERSION"
          echo "ttsim-version=$TTSIM_VERSION" >> $GITHUB_OUTPUT

      - name: Download ttsim binary (wh)
        uses: robinraju/release-downloader@daf26c55d821e836577a15f77d86ddc078948b05  # v1.12
        with:
          repository: tenstorrent/ttsim
          tag: ${{ steps.get-ttsim-version.outputs.ttsim-version }}
          fileName: "libttsim_wh.so"
          out-file-path: /tmp/ttsim-wh

      - name: Download ttsim binary (bh)
        uses: robinraju/release-downloader@daf26c55d821e836577a15f77d86ddc078948b05  # v1.12
        with:
          repository: tenstorrent/ttsim
          tag: ${{ steps.get-ttsim-version.outputs.ttsim-version }}
          fileName: "libttsim_bh.so"
          out-file-path: /tmp/ttsim-bh

      - name: Build tt-metal
        run: |
          cd tt-metal
          export TT_METAL_HOME=$(pwd)
          export TT_METAL_RUNTIME_ROOT=$(pwd)
          export PYTHONPATH=$(pwd)
          echo "TT_METAL_HOME=$(pwd)" >> $GITHUB_ENV
          echo "TT_METAL_RUNTIME_ROOT=$(pwd)" >> $GITHUB_ENV
          echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV
          ./build_metal.sh --build-programming-examples
          cd ../

      - name: Prepare sim paths
        run: |
          echo "Preparing sim paths"
          mkdir -p sim_wh sim_bh
          mv /tmp/ttsim-wh/libttsim_wh.so sim_wh/libttsim.so
          mv /tmp/ttsim-bh/libttsim_bh.so sim_bh/libttsim.so
          cp $TT_METAL_HOME/tt_metal/soc_descriptors/wormhole_b0_80_arch.yaml sim_wh/soc_descriptor.yaml
          cp $TT_METAL_HOME/tt_metal/soc_descriptors/blackhole_140_arch.yaml sim_bh/soc_descriptor.yaml

      - name: Run tt-sim wormhole tests
        run: |
          export TT_METAL_SIMULATOR=$(pwd)/sim_wh/libttsim.so
          TT_METAL_SLOW_DISPATCH_MODE=1 $TT_METAL_HOME/build/programming_examples/metal_example_add_2_integers_in_riscv

      - name: Run tt-sim blackhole tests
        run: |
          export TT_METAL_SIMULATOR=$(pwd)/sim_bh/libttsim.so
          TT_METAL_SLOW_DISPATCH_MODE=1 $TT_METAL_HOME/build/programming_examples/metal_example_add_2_integers_in_riscv

      - name: Run tt-metal C++ unit tests (wormhole_b0)
        env:
          TT_METAL_SIMULATOR_HOME: ${{ github.workspace }}/sim_wh
          TT_METAL_SIMULATOR: ${{ github.workspace }}/sim_wh/libttsim.so
          TT_METAL_SLOW_DISPATCH_MODE: 1
          TT_METAL_TESTS_DIR: ${{ github.workspace }}/tt-metal/tests/tt_metal/tt_fabric/custom_mock_cluster_descriptors
          TT_METAL_MOCK_CLUSTER_DESC_PATH: ${{ env.TT_METAL_TESTS_DIR }}/6u_cluster_desc.yaml
        run: |
          cd tt-metal
          echo "Running C++ unit tests for wormhole_b0..."
          ./build/test/tt_metal/unit_tests_api --gtest_filter="*StreamRegWrite*"
          ./build/test/tt_metal/unit_tests_api --gtest_filter="*InlineWrite*"

      - name: Run tt-metal C++ unit tests (blackhole)
        env:
          TT_METAL_SIMULATOR_HOME: ${{ github.workspace }}/sim_bh
          TT_METAL_SIMULATOR: ${{ github.workspace }}/sim_bh/libttsim.so
          TT_METAL_SLOW_DISPATCH_MODE: 1
          TT_METAL_TESTS_DIR: ${{ github.workspace }}/tt-metal/tests/tt_metal/tt_fabric/custom_mock_cluster_descriptors
          TT_METAL_MOCK_CLUSTER_DESC_PATH: ${{ env.TT_METAL_TESTS_DIR }}/bh_6u_cluster_desc.yaml
        run: |
          cd tt-metal
          echo "Running C++ unit tests for blackhole..."
          ./build/test/tt_metal/unit_tests_api --gtest_filter="*StreamRegWrite*"
          ./build/test/tt_metal/unit_tests_api --gtest_filter="*InlineWrite*"

      - name: Build UMD tests
        run: |
          cd tt-metal/tt_metal/third_party/umd
          echo "Compiling UMD tests..."
          cmake -B ./build -G Ninja \
            -DTT_UMD_BUILD_TESTS=ON \
            -DTT_UMD_BUILD_SIMULATION=ON \
            -DTT_UMD_BUILD_PYTHON=OFF \
            -DTT_UMD_BUILD_EXAMPLES=OFF \
            -DTT_UMD_BUILD_TOOLS=OFF \
            -DTT_UMD_ENABLE_CLANG_TIDY=OFF \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build ./build --target umd_tests
          echo "UMD tests compile complete."
          cd ../../../../

      - name: Run Galaxy unit tests with TTSim
        env:
          TT_UMD_SIMULATOR: $(pwd)/sim_wh/libttsim.so
          TT_UMD_SLOW_DISPATCH_MODE: 1
          TT_UMD_MOCK_CLUSTER_DESC_PATH: >-
            $(pwd)/tt-metal/tt_metal/third_party/umd/tests/cluster_descriptor_examples/6u_cluster_desc.yaml
          LD_LIBRARY_PATH: $(pwd)/tt-metal/tt_metal/third_party/umd/build/lib
        run: |
          cd tt-metal/tt_metal/third_party/umd
          echo "Running Galaxy unit tests with TTSim..."
          echo "TT_UMD_SIMULATOR=$TT_UMD_SIMULATOR"
          echo "TT_UMD_MOCK_CLUSTER_DESC_PATH=$TT_UMD_MOCK_CLUSTER_DESC_PATH"
          ./build/test/umd/galaxy/unit_tests_glx
