# Builds umd_tests.
name: Build Target

on:
  workflow_call:
    inputs:
      ubuntu-docker-version:
        required: true
        type: string
      docker-tag:
        required: false
        type: string
        default: latest
      timeout:
        required: true
        type: number
      build-type:
        required: true
        type: string
        default: Release
      log-params:
        required: false
        type: string
        default: ""
  workflow_dispatch:
    inputs:
      ubuntu-docker-version:
        required: true
        description: 'The version of Ubuntu to build on'
        type: choice
        options:
          - ubuntu-22.04
          - ubuntu-24.04
      docker-tag:
        required: false
        description: 'The docker tag to use'
        type: string
        default: latest
      timeout:
        required: true
        description: 'The timeout for the build job in minutes'
        type: number
      build-type:
        required: true
        default: Release
        type: choice
        options:
          - Release
          - RelWithDebInfo
          - Debug
          - ASan
          - TSan


env:
  BUILD_TARGETS: "umd_tests ubench"
  BUILD_OUTPUT_DIR: ./build
  LIB_OUTPUT_DIR: ./build/lib
  DEPS_OUTPUT_DIR: ./build/_deps
  TEST_OUTPUT_DIR: ./build/test
  WHEEL_OUTPUT_DIR: ./build/wheel
  CLUSTER_DESCRIPTORS_DIR: ./tests/cluster_descriptor_examples
  SOC_DESCRIPTORS_DIR: ./tests/soc_descs
  NANOBIND_TEST_DIR: ./nanobind/tests

jobs:
  build:
    name: Build (${{ inputs.build-type }}, ${{ inputs.ubuntu-docker-version }})
    # Due to parsing bug, fromJSON is used to convert string to number
    timeout-minutes: ${{ fromJSON(inputs.timeout) }}

    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/${{ github.repository }}/tt-umd-ci-${{ inputs.ubuntu-docker-version }}:${{ inputs.docker-tag }}

    steps:
      - name: Print all params
        run: |
          ${{ inputs.log-params }}
          echo build-tests - ubuntu-docker-version: ${{ inputs.ubuntu-docker-version }}
          echo build-tests - timeout: ${{ inputs.timeout }}
          echo build-tests - build-type: ${{ inputs.build-type }}

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Restore file timestamps to match git commit
        run: |
          mkdir build
          touch build/compile_commands.json
          git ls-files | while IFS= read -r file; do
            touch -d @$(git log -1 --format=%at -- "$file") "$file"
          done

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.BUILD_OUTPUT_DIR }}
            .cpmcache
          # yamllint disable rule:line-length
          key: build-tests-${{ inputs.ubuntu-docker-version }}-${{ inputs.docker-tag }}-${{ github.head_ref != '' && github.head_ref || github.ref_name }}-${{ inputs.build-type }}-${{ github.sha }}
          restore-keys: |
            build-tests-${{ inputs.ubuntu-docker-version }}-${{ inputs.docker-tag }}-${{ github.head_ref != '' && github.head_ref || github.ref_name }}-${{ inputs.build-type }}-
            build-tests-${{ inputs.ubuntu-docker-version }}-${{ inputs.docker-tag }}-main-${{ inputs.build-type }}-
          # yamllint enable rule:line-length

      # Only perform build with necessary components to run tests.
      - name: Build ${{ env.BUILD_TARGETS }}
        run: |
          echo "Compiling the code..."
          cmake -B ${{ env.BUILD_OUTPUT_DIR }} -G Ninja \
            -DTT_UMD_BUILD_TESTS=ON \
            -DTT_UMD_BUILD_SIMULATION=OFF \
            -DTT_UMD_BUILD_PYTHON=OFF \
            -DTT_UMD_BUILD_EXAMPLES=OFF \
            -DTT_UMD_BUILD_TOOLS=OFF \
            -DTT_UMD_ENABLE_CLANG_TIDY=OFF \
            -DCMAKE_BUILD_TYPE=${{ inputs.build-type || 'Release' }}
          echo "Running ninja explain for debugging purposes..."
          ninja -C build -n -d explain
          echo "Starting actual build..."
          cmake --build ${{ env.BUILD_OUTPUT_DIR }} --target ${{ env.BUILD_TARGETS }}
          echo "Compile complete."

      # This is needed to preserve file permissions
      # https://github.com/actions/upload-artifact?tab=readme-ov-file#permission-loss
      - name: Tar build, test and run artifacts
        shell: bash
        run: |
          tar cvf artifact.tar ${{ env.TEST_OUTPUT_DIR }} \
          ${{ env.LIB_OUTPUT_DIR }} \
          ${{ env.DEPS_OUTPUT_DIR }} \
          ${{ env.CLUSTER_DESCRIPTORS_DIR }} \
          ${{ env.SOC_DESCRIPTORS_DIR }}

      - name: Upload build artifacts archive
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ inputs.ubuntu-docker-version }}-${{ inputs.build-type }}
          path: artifact.tar

  build-wheel:
    # Due to parsing bug, fromJSON is used to convert string to number
    timeout-minutes: ${{ fromJSON(inputs.timeout) }}

    name: Build umd wheel on ${{ inputs.ubuntu-docker-version }}
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/${{ github.repository }}/tt-umd-ci-${{ inputs.ubuntu-docker-version }}:${{ inputs.docker-tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.BUILD_OUTPUT_DIR }}
            .cpmcache
          # yamllint disable rule:line-length
          key: build-tests-wheel-${{ inputs.ubuntu-docker-version }}-${{ inputs.docker-tag }}-${{ github.head_ref != '' && github.head_ref || github.ref_name }}-${{ inputs.build-type }}-${{ github.sha }}
          restore-keys: |
            build-tests-wheel-${{ inputs.ubuntu-docker-version }}-${{ inputs.docker-tag }}-${{ github.head_ref != '' && github.head_ref || github.ref_name }}-${{ inputs.build-type }}-
            build-tests-wheel-${{ inputs.ubuntu-docker-version }}-${{ inputs.docker-tag }}-main-${{ inputs.build-type }}-
          # yamllint enable rule:line-length

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build wheel
        shell: bash
        run: |
          echo "Cleaning up wheel directory in case of previous build..."
          rm -rf ${{ env.WHEEL_OUTPUT_DIR }}
          mkdir -p ${{ env.WHEEL_OUTPUT_DIR }}
          echo "Setting up virtual environment..."
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip wheel
          echo "Compiling the code..."
          # Override CMAKE_BUILD_TYPE to Release for sanitizer builds to avoid symbol conflicts with Python
          # Python interpreters are not built with sanitizers, so TSAN/ASAN wheels cannot be loaded
          BUILD_TYPE="${{ inputs.build-type }}"
          if [[ "$BUILD_TYPE" == "ASan" || "$BUILD_TYPE" == "TSan" ]]; then
            echo "Overriding CMAKE_BUILD_TYPE from $BUILD_TYPE to Release for Python wheel compatibility"
            WHEEL_BUILD_TYPE="Release"
          else
            echo "Using CMAKE_BUILD_TYPE=$BUILD_TYPE for Python wheel"
            WHEEL_BUILD_TYPE="$BUILD_TYPE"
          fi
          CMAKE_BUILD_TYPE="$WHEEL_BUILD_TYPE" pip wheel . --wheel-dir ${{ env.WHEEL_OUTPUT_DIR }}
          echo "Compile complete."

      - name: Move python bindings tests in the same wheel folder
        run: |
          cp -r ${{ env.NANOBIND_TEST_DIR }} ${{ env.WHEEL_OUTPUT_DIR }}/tests

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          # Note that wheel is built with hardcoded Release build type at the moment.
          name: wheel-artifact-${{ inputs.ubuntu-docker-version }}-${{ inputs.build-type }}
          path: ${{ env.WHEEL_OUTPUT_DIR }}
