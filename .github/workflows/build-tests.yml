# Builds umd_tests.
name: Build Target

on:
  workflow_call:
    inputs:
      ubuntu-docker-version:
        required: true
        type: string
      timeout:
        required: true
        type: number
      build-type:
        required: true
        type: string
        default: Release
      log-params:
        required: false
        type: string
        default: ""
  workflow_dispatch:
    inputs:
      ubuntu-docker-version:
        required: true
        description: 'The version of Ubuntu to build on'
        type: choice
        options:
          - ubuntu-22.04
          - ubuntu-24.04
      timeout:
        required: true
        description: 'The timeout for the build job in minutes'
        type: number
      build-type:
        required: true
        default: Release
        type: choice
        options:
          - Release
          - RelWithDebInfo
          - Debug
          - ASan
          - TSan


env:
  BUILD_TARGETS: "umd_tests ubench"
  BUILD_OUTPUT_DIR: ./build
  LIB_OUTPUT_DIR: ./build/lib
  DEPS_OUTPUT_DIR: ./build/_deps
  TEST_OUTPUT_DIR: ./build/test
  WHEEL_OUTPUT_DIR: ./build/wheel
  CLUSTER_DESCRIPTORS_DIR: ./tests/cluster_descriptor_examples
  SOC_DESCRIPTORS_DIR: ./tests/soc_descs
  NANOBIND_TEST_DIR: ./nanobind/tests

jobs:
  build:
    name: Build (${{ inputs.build-type }}, ${{ inputs.ubuntu-docker-version }})
    # Due to parsing bug, fromJSON is used to convert string to number
    timeout-minutes: ${{ fromJSON(inputs.timeout) }}

    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/${{ github.repository }}/tt-umd-ci-${{ inputs.ubuntu-docker-version }}:latest

    steps:
      - name: Print all params
        run: |
          ${{ inputs.log-params }}
          echo build-tests - ubuntu-docker-version: ${{ inputs.ubuntu-docker-version }}
          echo build-tests - timeout: ${{ inputs.timeout }}
          echo build-tests - build-type: ${{ inputs.build-type }}

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # Only perform build with necessary components to run tests.
      - name: Build ${{ env.BUILD_TARGETS }}
        run: |
          echo "Compiling the code..."
          cmake -B ${{ env.BUILD_OUTPUT_DIR }} -G Ninja \
            -DTT_UMD_BUILD_TESTS=ON \
            -DTT_UMD_BUILD_SIMULATION=OFF \
            -DTT_UMD_BUILD_PYTHON=OFF \
            -DTT_UMD_BUILD_EXAMPLES=OFF \
            -DTT_UMD_BUILD_TOOLS=OFF \
            -DTT_UMD_ENABLE_CLANG_TIDY=OFF \
            -DCMAKE_BUILD_TYPE=${{ inputs.build-type || 'Release' }}
          cmake --build ${{ env.BUILD_OUTPUT_DIR }} --target ${{ env.BUILD_TARGETS }}
          echo "Compile complete."

      # This is needed to preserve file permissions
      # https://github.com/actions/upload-artifact?tab=readme-ov-file#permission-loss
      - name: Tar build, test and run artifacts
        shell: bash
        run: |
          tar cvf artifact.tar ${{ env.TEST_OUTPUT_DIR }} \
          ${{ env.LIB_OUTPUT_DIR }} \
          ${{ env.DEPS_OUTPUT_DIR }} \
          ${{ env.CLUSTER_DESCRIPTORS_DIR }} \
          ${{ env.SOC_DESCRIPTORS_DIR }}

      - name: Upload build artifacts archive
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ inputs.ubuntu-docker-version }}-${{ inputs.build-type }}
          path: artifact.tar

  build-wheel:
    # Due to parsing bug, fromJSON is used to convert string to number
    timeout-minutes: ${{ fromJSON(inputs.timeout) }}

    name: Build umd wheel on ${{ inputs.ubuntu-docker-version }}
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/${{ github.repository }}/tt-umd-ci-${{ inputs.ubuntu-docker-version }}:latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build wheel
        shell: bash
        run: |
          echo "Cleaning up wheel directory in case of previous build..."
          rm -rf ${{ env.WHEEL_OUTPUT_DIR }}
          mkdir -p ${{ env.WHEEL_OUTPUT_DIR }}
          echo "Setting up virtual environment..."
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip wheel
          echo "Compiling the code..."
          # Override CMAKE_BUILD_TYPE to Release for sanitizer builds to avoid symbol conflicts with Python
          # Python interpreters are not built with sanitizers, so TSAN/ASAN wheels cannot be loaded
          BUILD_TYPE="${{ inputs.build-type }}"
          if [[ "$BUILD_TYPE" == "ASan" || "$BUILD_TYPE" == "TSan" ]]; then
            echo "Overriding CMAKE_BUILD_TYPE from $BUILD_TYPE to Release for Python wheel compatibility"
            WHEEL_BUILD_TYPE="Release"
          else
            echo "Using CMAKE_BUILD_TYPE=$BUILD_TYPE for Python wheel"
            WHEEL_BUILD_TYPE="$BUILD_TYPE"
          fi
          CMAKE_BUILD_TYPE="$WHEEL_BUILD_TYPE" pip wheel . --wheel-dir ${{ env.WHEEL_OUTPUT_DIR }}
          echo "Compile complete."

      - name: Move python bindings tests in the same wheel folder
        run: |
          cp -r ${{ env.NANOBIND_TEST_DIR }} ${{ env.WHEEL_OUTPUT_DIR }}/tests

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          # Note that wheel is built with hardcoded Release build type at the moment.
          name: wheel-artifact-${{ inputs.ubuntu-docker-version }}-${{ inputs.build-type }}
          path: ${{ env.WHEEL_OUTPUT_DIR }}

  build-exalens-kernels:
    name: Build tt-exalens kernels for tests
    timeout-minutes: 5
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/tenstorrent/tt-exalens/tt-exalens-ci-${{ inputs.ubuntu-docker-version }}:latest

    steps:
      - uses: actions/checkout@v4
        with:
          repository: tenstorrent/tt-exalens
          ref: main
          submodules: recursive

      - name: Build test kernels
        run: |
          make

      - name: Remove SFPI from build artifacts
        run: |
          mv build/sfpi build/sfpi_backup
          mkdir -p build/sfpi/compiler/bin/
          cp build/sfpi_backup/compiler/bin/riscv-tt-elf-gdb build/sfpi/compiler/bin/riscv-tt-elf-gdb
          rm -rf build/sfpi_backup
          rm -f build/sfpi_*

      - name: Upload libraries as artifacts
        uses: pyTooling/upload-artifact@v4
        with:
          name: ttexalens-build
          path: |
            build

  run-exalens-tests:
    name: Run tt-exalens tests
    needs:
      - build-wheel
      - build-exalens-kernels
    strategy:
      matrix:
        runner-info: [
          {arch: "blackhole", board: "p150b", runs-on: "tt-ubuntu-2204-p150b-stable"},
          {arch: "wormhole_b0", board: "n150", runs-on: "tt-ubuntu-2204-n150-stable"},
          {arch: "wormhole_b0", board: "n300", runs-on: "tt-ubuntu-2204-n300-stable"},
        ]
    runs-on: ${{ matrix.runner-info.runs-on }}
    container:
      image: ghcr.io/tenstorrent/tt-exalens/tt-exalens-ci-${{ inputs.ubuntu-docker-version }}:latest
      options: --device /dev/tenstorrent/0
      volumes:
        - /dev/hugepages:/dev/hugepages
        - /dev/hugepages-1G:/dev/hugepages-1G
        - /etc/udev/rules.d:/etc/udev/rules.d
        - /lib/modules:/lib/modules

    steps:
      - uses: actions/checkout@v4
        with:
          repository: tenstorrent/tt-exalens
          ref: main
          submodules: recursive

      - name: Get tt-exalens kernels artifact
        uses: actions/download-artifact@v4
        with:
          name: ttexalens-build

      - name: Get tt-umd wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheel-artifact-${{ inputs.ubuntu-docker-version }}-${{ inputs.build-type }}

      - name: Install tt-umd wheel
        run: |
          pip install ../tt_umd-*.whl --force-reinstall

      - name: Run Python tests for tt-exalens library
        run: |
          python3 -m unittest discover -v -t . -s test/ttexalens -p *test*.py

      - name: Run Python tests for tt-exalens app
        run: |
          python3 -m unittest discover -v -t . -s test/app -p *test*.py
