# Build and package .deb and .rpm via CPack
name: Release CPack Artifacts

on:
  workflow_dispatch:
  pull_request:

env:
  RELEASE_BUILD_TYPE: Release
  BUILD_OUTPUT_DIR: ./build

jobs:
  build-and-package:
    name: Build & CPack (${{ matrix.ubuntu-docker-version }})
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        ubuntu-docker-version: [
          'ubuntu-22.04',
          'ubuntu-24.04'
        ]
    container:
      image: ghcr.io/${{ github.repository }}/tt-umd-ci-${{ matrix.ubuntu-docker-version }}:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure
        run: |
          cmake -B ${{ env.BUILD_OUTPUT_DIR }} -G Ninja \
            -DTT_UMD_BUILD_TESTS=OFF \
            -DTT_UMD_BUILD_SIMULATION=OFF \
            -DTT_UMD_BUILD_PYTHON=OFF \
            -DTT_UMD_BUILD_EXAMPLES=OFF \
            -DCMAKE_BUILD_TYPE=${{ env.RELEASE_BUILD_TYPE }}

      - name: Build
        run: |
          cmake --build ${{ env.BUILD_OUTPUT_DIR }}

      - name: CPack (.deb)
        working-directory: ${{ env.BUILD_OUTPUT_DIR }}
        run: |
          cpack -G DEB

      - name: CPack (.rpm)
        working-directory: ${{ env.BUILD_OUTPUT_DIR }}
        run: |
          cpack -G RPM

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: tt-umd-cpack-${{ matrix.ubuntu-docker-version }}
          path: |
            ${{ env.BUILD_OUTPUT_DIR }}/*.deb
            ${{ env.BUILD_OUTPUT_DIR }}/*.rpm
          if-no-files-found: error
